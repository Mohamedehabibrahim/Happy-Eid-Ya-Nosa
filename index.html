<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ููุญุฉ ุชุญูู Hotjar</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
    }
    .kpi {
      @apply text-2xl font-bold text-blue-700;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-blue-100 text-gray-800 p-8 font-sans">
  <div class="max-w-7xl mx-auto">
    <h1 class="text-4xl font-bold mb-10 text-center text-blue-900">๐ ููุญุฉ ุชุญูู Hotjar ุงูุชูุงุนููุฉ</h1>

    <!-- KPIs -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
      <div class="card text-center">
        <div class="text-sm text-gray-500">ุฅุฌูุงูู ุงูุฌูุณุงุช</div>
        <div class="kpi" id="kpi-sessions">-</div>
      </div>
      <div class="card text-center">
        <div class="text-sm text-gray-500">ุนุฏุฏ ุงูุฏูู</div>
        <div class="kpi" id="kpi-countries">-</div>
      </div>
      <div class="card text-center">
        <div class="text-sm text-gray-500">ุฃููุงุน ุงูุฃุฌูุฒุฉ</div>
        <div class="kpi" id="kpi-devices">-</div>
      </div>
      <div class="card text-center">
        <div class="text-sm text-gray-500">ุงููุชุตูุญุงุช</div>
        <div class="kpi" id="kpi-browsers">-</div>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-10">
      <h2 class="text-xl font-semibold mb-4 text-gray-800">๐ฏ ููุชุฑุฉ ุญุณุจ ุงูุชุงุฑูุฎ</h2>
      <input type="date" id="date-filter" class="border border-gray-300 rounded p-2" />
    </div>

    <!-- Dashboard Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
      <div class="card">
        <h2 class="text-lg font-semibold mb-3 text-gray-700">ุงูุฌูุณุงุช ุญุณุจ ุงูุฏููุฉ</h2>
        <canvas id="countryChart" height="200"></canvas>
        <p id="insight-country" class="text-sm text-gray-600 mt-4"></p>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold mb-3 text-gray-700">ุงูุฌูุณุงุช ุญุณุจ ุงูุฌูุงุฒ</h2>
        <canvas id="deviceChart" height="200"></canvas>
        <p id="insight-device" class="text-sm text-gray-600 mt-4"></p>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold mb-3 text-gray-700">ูุณุชุฎุฏู ุฌุฏูุฏ ููุงุจู ุนุงุฆุฏ</h2>
        <canvas id="userTypeChart" height="200"></canvas>
        <p id="insight-userType" class="text-sm text-gray-600 mt-4"></p>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold mb-3 text-gray-700">ุงุณุชุฎุฏุงู ุงููุชุตูุญุงุช</h2>
        <canvas id="browserChart" height="200"></canvas>
        <p id="insight-browser" class="text-sm text-gray-600 mt-4"></p>
      </div>
    </div>

    <!-- Full Table View -->
    <div class="card mb-10">
      <h2 class="text-2xl font-semibold mb-4 text-gray-800">๐ ุฌุฏูู ุงูุจูุงูุงุช ุงููุงูู</h2>
      <div id="data-table"></div>
    </div>

    <!-- Summary Section -->
    <div class="card mb-10">
      <h2 class="text-xl font-semibold mb-2 text-gray-800">๐ ุงูุชุญูููุงุช ุงููุฎุชุตุฑุฉ</h2>
      <ul class="list-disc list-inside text-gray-700" id="summary-list"></ul>
    </div>

    <!-- Share Section -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-2 text-gray-800">๐ ูุดุงุฑูุฉ ุงูุนุฑุถ ุงูุชูุงุนูู</h2>
      <p class="text-gray-700">ููููู ูุดุงุฑูุฉ ูุฐุง ุงูุฑุงุจุท ููุงุทูุงุน ุนูู ุงูุจูุงูุงุช ูุจุงุดุฑุฉ:</p>
      <a href="https://docs.google.com/spreadsheets/d/1AUCjeT7bjq1SsCPkMP9YqgeANNQGYJeRyquAaKNk_KU" target="_blank" class="text-blue-600 underline break-words">https://docs.google.com/spreadsheets/d/1AUCjeT7bjq1SsCPkMP9YqgeANNQGYJeRyquAaKNk_KU</a>
    </div>
  </div>

  <script>
    const csvURL = 'https://docs.google.com/spreadsheets/d/1AUCjeT7bjq1SsCPkMP9YqgeANNQGYJeRyquAaKNk_KU/gviz/tq?tqx=out:csv';

    const filterInput = document.getElementById('date-filter');
    filterInput.addEventListener('change', () => loadAndRender(filterInput.value));

    function loadAndRender(dateFilter = '') {
      Papa.parse(csvURL, {
        download: true,
        header: true,
        fastMode: true,
        complete: function(results) {
          const data = results.data.filter(row => Object.values(row).some(x => x !== ''));
          const filtered = dateFilter ? data.filter(r => (r['Date'] || '').startsWith(dateFilter)) : data;

          const countryData = {};
          const deviceData = {};
          const userTypeData = {};
          const browserData = {};

          const countriesSet = new Set();
          const devicesSet = new Set();
          const browsersSet = new Set();

          const tableHeaders = Object.keys(data[0]);
          const tableRows = filtered.map(row => tableHeaders.map(h => row[h] || ''));

          document.getElementById('kpi-sessions').innerText = filtered.length;

          filtered.forEach(row => {
            const country = row['Country'] || 'ุบูุฑ ูุนุฑูู';
            const device = row['Device'] || 'ุบูุฑ ูุนุฑูู';
            const userType = row['User Type'] || 'ุบูุฑ ูุนุฑูู';
            const browser = row['Browser'] || 'ุบูุฑ ูุนุฑูู';

            countryData[country] = (countryData[country] || 0) + 1;
            deviceData[device] = (deviceData[device] || 0) + 1;
            userTypeData[userType] = (userTypeData[userType] || 0) + 1;
            browserData[browser] = (browserData[browser] || 0) + 1;

            countriesSet.add(country);
            devicesSet.add(device);
            browsersSet.add(browser);
          });

          document.getElementById('kpi-countries').innerText = countriesSet.size;
          document.getElementById('kpi-devices').innerText = devicesSet.size;
          document.getElementById('kpi-browsers').innerText = browsersSet.size;

          document.getElementById('summary-list').innerHTML = '';
          const summary = [
            `ุชู ุชุณุฌูู ${filtered.length} ุฌูุณุฉ.`,
            `ุงูุฒูุงุฑุงุช ูู ${countriesSet.size} ุฏููุฉ.`,
            `ุชู ุงุณุชุฎุฏุงู ${devicesSet.size} ููุน ุฌูุงุฒ.`,
            `ุฃุดูุฑ ุงููุชุตูุญุงุช: ${Object.entries(browserData).sort((a,b)=>b[1]-a[1]).slice(0,3).map(x => x[0]).join(', ')}`
          ];
          summary.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            document.getElementById('summary-list').appendChild(li);
          });

          renderChart('countryChart', countryData);
          renderChart('deviceChart', deviceData);
          renderChart('userTypeChart', userTypeData, 'pie');
          renderChart('browserChart', browserData, 'doughnut');

          document.getElementById('insight-country').textContent = `ุฃุนูู ุฏููุฉ: ${getTopEntry(countryData)}`;
          document.getElementById('insight-device').textContent = `ุงูุฃูุซุฑ ุงุณุชุฎุฏุงููุง: ${getTopEntry(deviceData)}`;
          document.getElementById('insight-userType').textContent = `ููุน ุงููุณุชุฎุฏู ุงูุฃุนูู: ${getTopEntry(userTypeData)}`;
          document.getElementById('insight-browser').textContent = `ุงููุชุตูุญ ุงูุฃุนูู: ${getTopEntry(browserData)}`;

          document.getElementById('data-table').innerHTML = '';
          new gridjs.Grid({
            columns: tableHeaders,
            data: tableRows,
            search: true,
            sort: true,
            pagination: { limit: 10 },
            style: {
              table: { border: '1px solid #ccc', width: '100%' },
              th: { background: '#f1f5f9', textAlign: 'right' },
              td: { padding: '8px' }
            }
          }).render(document.getElementById('data-table'));
        }
      });
    }

    function renderChart(id, dataObj, type = 'bar') {
      const ctx = document.getElementById(id).getContext('2d');
      new Chart(ctx, {
        type: type,
        data: {
          labels: Object.keys(dataObj),
          datasets: [{
            label: '',
            data: Object.values(dataObj),
            backgroundColor: [
              '#3B82F6', '#10B981', '#F59E0B', '#EF4444',
              '#8B5CF6', '#EC4899', '#22D3EE', '#64748B'
            ],
            borderRadius: 8
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: type !== 'bar' } },
          scales: type === 'bar' ? { y: { beginAtZero: true } } : {}
        }
      });
    }

    function getTopEntry(obj) {
      const sorted = Object.entries(obj).sort((a, b) => b[1] - a[1]);
      return sorted.length > 0 ? `${sorted[0][0]} (${sorted[0][1]})` : 'ุบูุฑ ูุชููุฑ';
    }

    // Initial load
    loadAndRender();
  </script>
</body>
</html>
